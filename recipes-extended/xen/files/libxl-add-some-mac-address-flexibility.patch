Index: xen-4.6.1/tools/libxl/libxl_types.idl
===================================================================
--- xen-4.6.1.orig/tools/libxl/libxl_types.idl
+++ xen-4.6.1/tools/libxl/libxl_types.idl
@@ -579,6 +579,8 @@ libxl_device_nic = Struct("device_nic",
     ("mtu", integer),
     ("model", string),
     ("mac", libxl_mac),
+    ("mac_ioemu", libxl_mac),
+    ("mac_stubdom", libxl_mac),
     ("ip", string),
     ("bridge", string),
     ("ifname", string),
Index: xen-4.6.1/tools/libxl/xl_cmdimpl.c
===================================================================
--- xen-4.6.1.orig/tools/libxl/xl_cmdimpl.c
+++ xen-4.6.1/tools/libxl/xl_cmdimpl.c
@@ -1025,6 +1025,26 @@ static int parse_nic_config(libxl_device
             nic->mac[i] = val;
             oparg = endptr + 1;
         }
+    } else if (MATCH_OPTION("mac_ioemu", token, oparg)) {
+        for (i = 0; i < 6; i++) {
+            val = strtoul(oparg, &endptr, 16);
+            if ((oparg == endptr) || (val > 255)) {
+                fprintf(stderr, "Invalid parameter `mac'.\n");
+                return 1;
+            }
+            nic->mac_ioemu[i] = val;
+            oparg = endptr + 1;
+        }
+    } else if (MATCH_OPTION("mac_stubdom", token, oparg)) {
+        for (i = 0; i < 6; i++) {
+            val = strtoul(oparg, &endptr, 16);
+            if ((oparg == endptr) || (val > 255)) {
+                fprintf(stderr, "Invalid parameter `mac'.\n");
+                return 1;
+            }
+            nic->mac_stubdom[i] = val;
+            oparg = endptr + 1;
+        }
     } else if (MATCH_OPTION("bridge", token, oparg)) {
         replace_string(&nic->bridge, oparg);
     } else if (MATCH_OPTION("netdev", token, oparg)) {
Index: xen-4.6.1/tools/libxl/libxl_dm.c
===================================================================
--- xen-4.6.1.orig/tools/libxl/libxl_dm.c
+++ xen-4.6.1/tools/libxl/libxl_dm.c
@@ -591,8 +591,11 @@ static int libxl__build_device_model_arg
 		if(b_info->stubdom) {
 			for (i = 0; i < num_nics; i++) {
 				if (nics[i].nictype == LIBXL_NIC_TYPE_VIF_IOEMU) {
-					char *smac = libxl__sprintf(gc,
-									   LIBXL_MAC_FMT, LIBXL_MAC_BYTES(nics[i].mac));
+                                        char *smac;
+                                        if (!libxl__mac_is_default(&nics[i].mac_ioemu))
+                                                smac = libxl__sprintf(gc, LIBXL_MAC_FMT, LIBXL_MAC_BYTES(nics[i].mac_ioemu));
+                                        else
+                                                smac = libxl__sprintf(gc, LIBXL_MAC_FMT, LIBXL_MAC_BYTES(nics[i].mac));
 					const char *ifname = libxl__device_nic_devname(gc,
 													domid, nics[i].devid,
 													LIBXL_NIC_TYPE_VIF_IOEMU);
@@ -1033,8 +1036,11 @@ static int libxl__build_device_model_arg
 		if (b_info->stubdom) {
 			for (i = 0; i < num_nics; i++) {
 				if (nics[i].nictype == LIBXL_NIC_TYPE_VIF_IOEMU) {
-					char *smac = libxl__sprintf(gc,
-									LIBXL_MAC_FMT, LIBXL_MAC_BYTES(nics[i].mac));
+                                        char *smac;
+                                        if (!libxl__mac_is_default(&nics[i].mac_ioemu))
+                                                smac = libxl__sprintf(gc, LIBXL_MAC_FMT, LIBXL_MAC_BYTES(nics[i].mac_ioemu));
+                                        else
+                                                smac = libxl__sprintf(gc, LIBXL_MAC_FMT, LIBXL_MAC_BYTES(nics[i].mac));
 					const char *ifname = libxl__device_nic_devname(gc,
 													guest_domid, nics[i].devid,
 													LIBXL_NIC_TYPE_VIF_IOEMU);
@@ -1271,6 +1277,8 @@ static void libxl__dm_vifs_from_hvm_gues
 
     for (i=0; i<nr; i++) {
         dm_config->nics[i] = guest_config->nics[i];
+        if (!libxl__mac_is_default(&guest_config->nics[i].mac_stubdom))
+            memcpy(dm_config->nics[i].mac, guest_config->nics[i].mac_stubdom, 6);
         dm_config->nics[i].nictype = LIBXL_NIC_TYPE_VIF;
         if (dm_config->nics[i].ifname)
             dm_config->nics[i].ifname = GCSPRINTF("%s" TAP_DEVICE_SUFFIX,
Index: xen-4.6.1/tools/libxl/libxl_internal.c
===================================================================
--- xen-4.6.1.orig/tools/libxl/libxl_internal.c
+++ xen-4.6.1/tools/libxl/libxl_internal.c
@@ -328,7 +328,7 @@ _hidden int libxl__compare_macs(libxl_ma
     return 0;
 }
 
-_hidden int libxl__mac_is_default(libxl_mac *mac)
+_hidden int libxl__mac_is_default(const libxl_mac *mac)
 {
     return (!(*mac)[0] && !(*mac)[1] && !(*mac)[2] &&
             !(*mac)[3] && !(*mac)[4] && !(*mac)[5]);
Index: xen-4.6.1/tools/libxl/libxl_internal.h
===================================================================
--- xen-4.6.1.orig/tools/libxl/libxl_internal.h
+++ xen-4.6.1/tools/libxl/libxl_internal.h
@@ -1714,7 +1714,7 @@ _hidden int libxl__parse_mac(const char
 /* compare mac address @a and @b. 0 if the same, -ve if a<b and +ve if a>b */
 _hidden int libxl__compare_macs(libxl_mac *a, libxl_mac *b);
 /* return true if mac address is all zero (the default value) */
-_hidden int libxl__mac_is_default(libxl_mac *mac);
+_hidden int libxl__mac_is_default(const libxl_mac *mac);
 /* init a recursive mutex */
 _hidden int libxl__init_recursive_mutex(libxl_ctx *ctx, pthread_mutex_t *lock);
 
